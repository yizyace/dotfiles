# Fix permission error: https://github.com/ohmyzsh/ohmyzsh/issues/6835#issuecomment-390216875
ZSH_DISABLE_COMPFIX=true

# Path to your oh-my-zsh installation.
export ZSH=$HOME/.oh-my-zsh

# Set name of the theme to load.
# Look in ~/.oh-my-zsh/themes/
# Optionally, if you set this to "random", it'll load a random theme each
# time that oh-my-zsh is loaded.
# ZSH_THEME="robbyrussell"
ZSH_THEME="agnoster"

# Uncomment the following line to use case-sensitive completion.
# CASE_SENSITIVE="true"

# Uncomment the following line to disable bi-weekly auto-update checks.
# DISABLE_AUTO_UPDATE="true"

# Uncomment the following line to change how often to auto-update (in days).
# export UPDATE_ZSH_DAYS=13

# Uncomment the following line to disable colors in ls.
# DISABLE_LS_COLORS="true"

# Uncomment the following line to disable auto-setting terminal title.
# DISABLE_AUTO_TITLE="true"

# Uncomment the following line to enable command auto-correction.
# ENABLE_CORRECTION="true"

# Uncomment the following line to display red dots whilst waiting for completion.
# COMPLETION_WAITING_DOTS="true"

# Uncomment the following line if you want to disable marking untracked files
# under VCS as dirty. This makes repository status check for large repositories
# much, much faster.
# DISABLE_UNTRACKED_FILES_DIRTY="true"

# Uncomment the following line if you want to change the command execution time
# stamp shown in the history command output.
# The optional three formats: "mm/dd/yyyy"|"dd.mm.yyyy"|"yyyy-mm-dd"
# HIST_STAMPS="mm/dd/yyyy"

# Would you like to use another custom folder than $ZSH/custom?
# ZSH_CUSTOM=/path/to/new-custom-folder

# Which plugins would you like to load? (plugins can be found in ~/.oh-my-zsh/plugins/*)
# Custom plugins may be added to ~/.oh-my-zsh/custom/plugins/
# Example format: plugins=(rails git textmate ruby lighthouse)
# Add wisely, as too many plugins slow down shell startup.
plugins=(dircycle git bundler brew wd asdf)

source $ZSH/oh-my-zsh.sh

# User configuration
export PATH="/usr/local/anaconda3/bin:$PATH"

export EDITOR='vim'
export HOMEBREW_NO_ANALYTICS=1
# export MANPATH="/usr/local/man:$MANPATH"

# You may need to manually set your language environment
# export LANG=en_US.UTF-8

# Preferred editor for local and remote sessions
# if [[ -n $SSH_CONNECTION ]]; then
#   export EDITOR='vim'
# else
#   export EDITOR='mvim'
# fi

# Compilation flags
# export ARCHFLAGS="-arch x86_64"

# ssh
# export SSH_KEY_PATH="~/.ssh/dsa_id"

# Set personal aliases, overriding those provided by oh-my-zsh libs,
# plugins, and themes. Aliases can be placed here, though oh-my-zsh
# users are encouraged to define aliases within the ZSH_CUSTOM folder.
# For a full list of active aliases, run `alias`.
#alias vim='mvim -v'
#alias vimm="vim -u NONE" # Load vim without reading .vimrc

# The various escape codes that we can use to color our prompt.
RED="\[\033[0;31m\]"
YELLOW="\[\033[0;33m\]"
GREEN="\[\033[0;32m\]"
BLUE="\[\033[0;34m\]"
LIGHT_RED="\[\033[1;31m\]"
LIGHT_GREEN="\[\033[1;32m\]"
WHITE="\[\033[1;37m\]"
LIGHT_GRAY="\[\033[0;37m\]"
COLOR_NONE="\[\e[0m\]"

# Custom aliases
alias rspec="foreman run rspec spec"
alias iosim="open /Applications/Xcode.app/Contents/Developer/Applications/Simulator.app"
alias hps="heroku ps"
alias ls='ls -G'
alias ll='ls -hl'
alias pd='pushd'
alias pop='popd'
alias tm='tmux'
alias fup='foreman start web'
alias resetdnscache='sudo dscacheutil -flushcache; sudo killall -HUP mDNSResponder'

#Custom
# bindkey "[D" backward-word
# bindkey "[C" forward-word

function popstar {
  history | awk '{print $2}'|awk 'BEGIN {FS="|"} {print $1}'|sort|uniq -c|sort -r
}

export PATH=/usr/local/bin:$PATH

# added by Anaconda3 5.0.1 installer
export PATH="$HOME/anaconda3/bin:$PATH"

PGHOST=localhost
export PATH="/usr/local/sbin:$PATH"

# For ctrl-s saving in vim (disales terminal from interpreting ctrl + s)
vim() STTY=-ixon command vim "$@"

# Add RVM to PATH for scripting. Make sure this is the last PATH variable change.
export PATH="$PATH:$HOME/.rvm/bin"

export PATH="$HOME/.yarn/bin:$HOME/.config/yarn/global/node_modules/.bin:$PATH"

# https://github.com/fohte/rubocop-daemon#more-speed
export PATH="/usr/local/bin/rubocop-daemon-wrapper:$PATH"

# https://news.ycombinator.com/item?id=26083919
vscodetmp () {
	local repo=$1
	[[ ! $repo =~ "https://*" ]] && repo="https://github.com/${repo}"
	local temp="$(mktemp -d)"
	git clone --single-branch "${repo}" "${temp}"
	code --wait -n "${temp}"
	rm -rf "${temp}"
}

  # Rename all files in a directory
rename-shit-names() {
    mv "s/ /-/g" *
    mv "s/_/-/g" *
    mv "s/–/-/g" *
    mv "s/://g" *
    mv "s/\(//g" *
    mv "s/\)//g" *
    mv "s/\[//g" *
    mv "s/\]//g" *
    mv 's/"//g' *
    mv "s/'//g" *
    mv "s/,//g" *
    mv "y/A-Z/a-z/" *
    mv "s/---/--/g" *
    mv "s/-‎--/--/g" *
  }









# AWS SSM Stuff
# Environment → profile mapping
typeset -A SSM_ENV_PROFILES
SSM_ENV_PROFILES=(
  test 324301042932_AccountFullAdmin
  int  357454778135_AccountFullAdmin
  prod 011614424008_AccountFullAdmin
)

# Shared usage function
print_ssm_usage() {
  echo "Usage: $1 {test|int|prod} [instance-id]"
  echo ""
  echo "Valid environments:"
  for e in "${(@k)SSM_ENV_PROFILES}"; do
    echo "  $e → ${SSM_ENV_PROFILES[$e]}"
  done
}

# Shared env/profile validation function
get_ssm_profile_or_exit() {
  local env="$1"
  local caller="$2"

  if [[ "$env" == "--list" || "$env" == "help" || "$env" == "--help" || "$env" == "-h" ]]; then
    print_ssm_usage "$caller"
    return 1
  fi

  local profile="${SSM_ENV_PROFILES[$env]}"
  if [[ -z "$profile" ]]; then
    echo "❌ Invalid environment: '$env'"
    echo ""
    print_ssm_usage "$caller"
    return 1
  fi

  echo "$profile"
}

# ssm-ec2 command
ssm-ec2() {
  local env="$1"
  local profile

  profile=$(get_ssm_profile_or_exit "$env" "ssm-ec2")
  if [[ -z "$profile" ]]; then
    return 1
  fi

  aws ec2 describe-instances \
    --profile "$profile" \
    --query 'Reservations[*].Instances[*].{ID:InstanceId,State:State.Name,Name:Tags[?Key==`Name`]|[0].Value}' \
    --output table
}

# ssm-ssh command
ssm-ssh() {
  local env="$1"
  local instance_id="$2"
  local profile

  profile=$(get_ssm_profile_or_exit "$env" "ssm-ssh")
  if [[ -z "$profile" ]]; then
    return 1
  fi

  if [[ -z "$instance_id" ]]; then
    echo "No instance ID provided — launching interactive selector..."

    instance_id=$(
      aws ec2 describe-instances \
        --no-cli-pager \
        --profile "324301042932_AccountFullAdmin" \
        --query 'Reservations[*].Instances[*].{ID:InstanceId,Name:Tags[?Key==`Name`]|[0].Value}' \
        --output table | tail -n +5 | awk '{print $2}' | fzf --header "Select an EC2 instance to connect via SSM" | awk '{print $1}'
    )

    if [[ -z "$instance_id" ]]; then
      echo "❌ No instance selected."
      return 1
    fi
  fi

  aws ssm start-session \
    --target "$instance_id" \
    --profile "$profile"
}

